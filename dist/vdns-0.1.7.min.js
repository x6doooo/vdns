/**
 * vdns
 * @version v0.1.7
 * @author Dx.Yang <x6doooo@gmail.com>
 * @link https://github.com/x6doooo/vdns
 * @license https://github.com/x6doooo/vdns/raw/master/LICENSE
 */
function vdnsFormat(t){function n(t,n,e){function i(t){var n=4;return t.length>n?t.substr(0,n)+"...":t}a[n]={};var r=[];$.each(t,function(t,n){r.push({province:t,cities:n})}),r.sort(function(t,n){return t.province.localeCompare(n.province)});var o,c,u,s=[],l=[],_=[];return $.each(r,function(t,r){o={name:i(r.province),fullname:r.province},o[n]=null,o[e]=[],s.push(o),$.each(r.cities,function(t,r){c={name:i(t),fullname:t},c[n]=[s.length-1],c[e]=[],l.push(c),o[e].push(l.length-1),$.each(r,function(t,r){u={name:i(t),nodeName:r.__nodeName__,ips:r},delete r.__nodeName__,r.__clientIPs__&&(u.clientIPs=r.__clientIPs__,delete r.__clientIPs__),u[n]=[l.length-1],u[e]=[],_.push(u),c[e].push(_.length-1),$.each(r,function(t){a[n][t]||(a[n][t]=[]),a[n][t].push(_.length-1)})})})}),"left"==n?[s,l,_]:[_,l,s]}function e(){$.each(i[2],function(t,n){$.each(n.ips,function(t){n.right=n.right.concat(a.right[t])}),n.right=_.uniq(n.right)}),$.each(r[0],function(t,n){$.each(n.ips,function(t){n.left=n.left.concat(a.left[t])}),n.left=_.uniq(n.left)})}var i={},r={};$.each(t,function(t,n){null===n.error&&null!==n.node_province&&null!==n.node_city&&null!==n.node_name&&null!==n.isp&&n.ips&&n.ips.length&&(i[n.node_province]||(i[n.node_province]={}),i[n.node_province][n.node_city]||(i[n.node_province][n.node_city]={}),i[n.node_province][n.node_city][n.isp]||(i[n.node_province][n.node_city][n.isp]={__nodeName__:n.node_name,__clientIPs__:{}}),$.each(n.ips,function(t,e){i[n.node_province][n.node_city][n.isp].__clientIPs__[n.client_ip]=!0,i[n.node_province][n.node_city][n.isp][e.ip]=!0;var a=e.location.replace(/市|省|回族自治区|壮族自治区|维吾尔自治区/g,";");a=a.replace(/\s/g,""),a=a.replace(/国|州|地区/g,function(t){return t+";"}),a=a.split(";"),a=_.compact(a);var o,c,u;switch(a.length){case 1:u=c=o=a[0];break;case 2:u=a[1],c=o=a[0];break;case 3:o=a[0],c=a[1],u=a[2];break;default:o=c=u="未知"}r[o]||(r[o]={}),r[o][c]||(r[o][c]={}),r[o][c][u]||(r[o][c][u]={__nodeName__:e.location}),r[o][c][u][e.ip]=!0}))});var a={};return i=n(i,"left","right"),r=n(r,"right","left"),e(),i.concat(r)}!function(t,n,e,i){function r(t,n,e,i){return"M"+t[0]+","+t[1]+" Q"+n[0]+","+n[1]+" "+e[0]+","+e[1]+" T"+i[0]+","+i[1]}function a(t,i,r,a,o,c){for(var u,s,l,_=[r];i>=0&&i<t.length;)o[i]={},u=[],l=[],n.each(_,function(n,e){s=t[i][e],l=l.concat(s[a]),u.push(s),o[i][e]=u.length-1}),_=e.uniq(l),_.sort(function(t,n){return t-n}),i=c(i)}function o(t,n,e){var i=[];return a(t,n,e,"right",i,function(t){return t+1}),a(t,n,e,"left",i,function(t){return t-1}),i[n][e]=0,i}function c(t,n,e){return new c.prototype.init(t,n,e)}var u=n('<div class="vdns-tooltip"></div>');c.prototype={constructor:c,init:function(t,n,e){var i=this;return t?(i.__containerSelector__=t,i.__container__=d3.select(t),i.svg=i.__container__.append("svg"),i.svg.attr({width:n||1e3,height:e||600}),void i.config()):i},config:function(t){t=t||{};var e=this.__config__||{color:"#fff",duration:800,ease:"bounce",circleRadiu:3,rectStrokeWidth:1,clientStroke:"#08c",resultStroke:"#690",rectWidth:60,rectHeight:14,boxPadding:40,lineHeight:20};this.__config__=n.extend(e,t,!0)},_formatIndex:function(t){function e(t,n,e){e.__idx__=n,c=h[t],i=c.next,r=c.final,a=c.side,_[i][e[a][0]]||(_[i][e[a][0]]=!0,o=l[i][e[a][0]],o.__idx__=n,_[r][o[a][0]]||(_[r][o[a][0]]=!0,l[r][o[a][0]].__idx__=n))}var i,r,a,o,c,u,s=this,l=s.__sourceData__,_=[[],[],[],[],[],[]],h={2:{next:1,"final":0,side:"left"},3:{next:4,"final":5,side:"right"}};n.each([2,3],function(i,r){t?(u=0,n.each(t[r],function(t){e(r,u++,l[r][t])})):n.each(l[r],function(t,n){e(r,t,n)})})},resizeSvg:function(t){this.svg.transition().duration(this.__config__.duration).attr("height",(t-1)*this.__config__.lineHeight+2*this.__config__.boxPadding)},load:function(t){this.__sourceData__=t;var n=d3.max(t,function(t){return t.length}),e=this.__config__;this.resizeSvg(n);var i=d3.scale.linear().domain([0,t.length-1]).range([e.boxPadding,this.svg.attr("width")-e.boxPadding]);this._formatIndex(),this.getX=function(t){var n=i(t);return 3>t?n-20*t:n+20*(5-t)},this.getY=function(n,i){return t[i][n].__idx__*e.lineHeight+e.boxPadding},this.render()},render:function(){function t(t,r){if(1!=t.attr("opacity")){if(r)return;return void e()}var a=t.position(),c=50;"rect"==t.prop("tagName")&&(c=68),u.appendTo(i.__containerSelector__).css({top:a.top,left:a.left+c}).html(t.attr("data-msg"));var s=1*t.attr("data-pi"),l=t.attr("data-i"),_=n.extend([],i.__sourceData__,!0);r&&!i.lastChangeMap&&(i.lastChangeMap=i.changeMap),i.changeMap=o(_,s,l),r||(i.lastChangeMap=i.changeMap),i.refresh(i.changeMap,r)}function e(t){if(u.remove(),t&&i.lastChangeMap)return void i.refresh(i.lastChangeMap);t||(i.lastChangeMap=null);var e=[];n.each(c,function(t,i){e[t]=[],n.each(i,function(n){e[t][n]=n})}),i.changeMap=e,i.refresh(e)}var i=this,a=i.__config__,c=n.extend([],i.__sourceData__,!0),s=i.svg,l=i.getX,_=i.getY;n.each(c,function(t,e){var i=s.append("g");n.each(e,function(e,o){o.right&&n.each(o.right,function(n,o){var c=[l(t)+a.rectWidth/2,_(e,t)],u=[l(t+1)-a.rectWidth/2,_(o,t+1)],s=[(u[0]-c[0])/4+c[0],c[1]],h=[(u[0]-c[0])/2+c[0],(u[1]-c[1])/2+c[1]],f=_(0,t),d=r(c,s,h,u),p=[c[0],f],g=[s[0],f],v=[h[0],f],m=[u[0],f],x=r(p,g,v,m);i.append("path").attr({"data-from-idx":t,"data-from-i":e,"data-to-i":o,d:x,fill:"none",stroke:"#333","stroke-width":.5}).transition().duration(a.duration).ease(a.ease).attr("d",d)})});var o=i.selectAll("rect"),c=i.selectAll("text");o=o.data(e),o.enter().append("rect").style("cursor","pointer").attr({"data-msg":function(t){if(t.clientIPs){var e=[t.nodeName,"客户端IP："];return n.each(t.clientIPs,function(t){e.push(t)}),e.join("<br>")}if(t.ips){var e=[t.nodeName,"解析IP："];return n.each(t.ips,function(t){e.push(t)}),e.join("<br>")}return t.fullname},rx:5,ry:5,fill:function(){return t>2?a.resultStroke:a.clientStroke},stroke:function(){return t>2?a.resultStroke:a.clientStroke},width:a.rectWidth,height:a.rectHeight,"stroke-width":a.rectStrokeWidth,x:function(){return l(t)-a.rectWidth/2},y:function(e,i){return n(this).attr({"data-pi":t,"data-i":i}),_(0,t)-a.rectHeight/2}}).transition().duration(a.duration).ease(a.ease).attr({y:function(n,e){return _(e,t)-a.rectHeight/2}}),c.data(e).enter().append("text").style("cursor","pointer").text(function(t){return t.name}).attr({"data-msg":function(t){if(t.clientIPs){var e=[t.nodeName,"客户端IP："];return n.each(t.clientIPs,function(t){e.push(t)}),e.join("<br>")}if(t.ips){var e=[t.nodeName,"解析IP："];return n.each(t.ips,function(t){e.push(t)}),e.join("<br>")}return t.fullname},"class":function(n,e){return"text-"+t+"-"+e},x:function(){return l(t)},y:function(e,i){return n(this).attr({"data-pi":t,"data-i":i}),_(0,t)},fill:a.color,"text-anchor":"middle","alignment-baseline":"middle","font-size":12}).transition().duration(a.duration).ease(a.ease).attr({y:function(n,e){return _(e,t)}})}),e(),s.selectAll("rect").on("click",function(){t(n(this))}).on("mouseover",function(){t(n(this),!0)}).on("mouseout",function(){e(!0)}),s.selectAll("text").on("click",function(){t(n(this))}).on("mouseover",function(){t(n(this),!0)}).on("mouseout",function(){e(!0)}),s.selectAll("path").on("click",function(){e()}),n(document).on("click",function(t){return"HTML"===t.target.tagName?(e(),!1):void 0}),n(s[0][0]).on("click",function(t){return"svg"===t.target.tagName?(e(),!1):void 0})},refresh:function(t,a){var o=this,c=o.__config__,u=o.svg;this._formatIndex(t);var s=o.getX,l=o.getY,_=u.selectAll("g"),h=_.selectAll("rect"),f=_.selectAll("text"),d=_.selectAll("path"),p=0;if(a&&(p=.2),h.attr({opacity:function(e,r,o){return a&&0==n(this).attr("opacity")?t[o][r]===i?0:p:t[o][r]===i?p:1}}),f.attr({opacity:function(e,r,o){return a&&0==n(this).attr("opacity")?t[o][r]===i?0:p:t[o][r]===i?p:1}}),d.attr({opacity:function(e,r,o){var c=n(this).attr("data-from-i"),u=n(this).attr("data-to-i");return a&&0==n(this).attr("opacity")?t[o][c]===i||t[o+1][u]===i?0:p:t[o][c]===i||t[o+1][u]===i?0:1}}),!a){var g=d3.max(t,function(t){return e.size(t)});this.resizeSvg(g),h.transition().duration(c.duration).ease(c.ease).attr({y:function(t,n,e){return l(n,e)-c.rectHeight/2}}),f.transition().duration(c.duration).ease(c.ease).attr({y:function(t,n,e){return l(n,e)}}),d.transition().duration(c.duration).ease(c.ease).attr({d:function(t,e,i){var a=n(this).attr("data-from-i"),o=n(this).attr("data-to-i"),u=[s(i)+c.rectWidth/2,l(a,i)],_=[s(i+1)-c.rectWidth/2,l(o,i+1)],h=[(_[0]-u[0])/4+u[0],u[1]],f=[(_[0]-u[0])/2+u[0],(_[1]-u[1])/2+u[1]];return r(u,h,f,_)}})}}},c.prototype.init.prototype=c.prototype,t.VDNS=c}(window,jQuery,_);